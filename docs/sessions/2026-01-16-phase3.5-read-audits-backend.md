# Session: Phase 3.5 - Read & Audits Backend

**Date:** 2026-01-16
**Phase:** 3.5 (Auto-Blog System - Public API Endpoints)
**Status:** Complete âœ“

---

## Objective

Implement public-facing backend endpoints for Read page (blog articles) and Audits page (claim card repository).

---

## Reference Documents

- `/docs/decisions/003-auto-blog-system.md` (lines 385-483: Read vs Audits, lines 520-523: API Design)
- `/docs/sessions/2026-01-16-phase3-planning.md` (lines 184-188: Phase 3.5 scope)
- Existing patterns: `src/backend/database/repositories.py` (BlogPostRepository, ClaimCardRepository)

---

## Scope

**Read Page:**
- GET /api/blog/posts (list published articles)
- GET /api/blog/posts/{id} (single article detail)
- Only returns published articles (published_at NOT NULL)
- Pagination support

**Audits Page:**
- GET /api/audits/cards (list claim cards)
- GET /api/audits/cards/{id} (single card detail)
- Only returns visible cards (visible_in_audits = TRUE)
- Filtering: category, verdict, text search
- Pagination support

---

## Implementation Summary

### 1. Enhanced ClaimCardRepository (`src/backend/database/repositories.py`)

**Updated `get_all()` method** (lines 38-93):
- Added `visible_in_audits` filter parameter (Optional[bool])
- Added `verdict` filter parameter (Optional[str]) - filters by VerdictEnum
- Added `search` filter parameter (Optional[str]) - case-insensitive text search on claim_text using ILIKE
- All filters applied to base query before pagination

**Added `count()` method** (lines 95-136):
- Matches all filters from `get_all()` for accurate pagination
- Returns total count of matching claim cards
- Uses SQLAlchemy `func.count()` for efficiency

### 2. Enhanced BlogPostRepository (`src/backend/database/repositories.py`)

**Added `count()` method** (lines 592-608):
- Takes `published_only` parameter (matches `get_all()`)
- Returns total count of blog posts
- Supports accurate pagination for Read page

### 3. Public API Endpoints (`src/backend/main.py`)

Added new section: "PUBLIC ENDPOINTS - Read Page & Audits Page (Phase 3.5)" (lines 1501-1751)

**Blog Post Endpoints:**

`GET /api/blog/posts` (lines 1505-1544):
- Query params: skip (default: 0), limit (default: 20, max: 100)
- Returns: `{ posts: [...], total: int, has_more: bool }`
- Only published posts (published_at NOT NULL)
- Response includes: id, title, article_body, claim_card_ids, published_at, created_at

`GET /api/blog/posts/{post_id}` (lines 1547-1583):
- Path param: post_id (UUID)
- Returns single published blog post or 404
- 404 if not found OR not published

**Claim Card Endpoints:**

`GET /api/audits/cards` (lines 1586-1677):
- Query params:
  - skip (default: 0)
  - limit (default: 50, max: 100)
  - category (optional)
  - verdict (optional: "True", "False", "Misleading", etc.)
  - search (optional: text search on claim_text)
- Returns: `{ claim_cards: [...], total: int, has_more: bool }`
- Only visible cards (visible_in_audits = TRUE)
- Response includes: id, claim_text, claimant, claim_type, verdict, short_answer, deep_answer, why_persists, confidence_level, confidence_explanation, created_at, category_tags[], sources[], apologetics_tags[]

`GET /api/audits/cards/{card_id}` (lines 1680-1750):
- Path param: card_id (UUID)
- Returns single claim card with full details or 404
- 404 if not found OR not visible in audits
- Response includes: all claim card fields + agent_audit, updated_at

---

## Design Decisions

### Pagination Pattern
- Used existing pattern from `/api/claim-cards` endpoint (lines 130-204)
- Returns: `{ data: [...], total: int, has_more: bool }`
- `has_more` calculated as: `skip + len(results) < total`
- Frontend can use this for "Load More" buttons

### Filter Validation
- Verdict filter uses VerdictEnum validation in repository layer
- Invalid verdict values will raise ValueError (caught by FastAPI as 422)
- Search uses PostgreSQL ILIKE for case-insensitive matching
- All filters are optional (None = no filter applied)

### Visibility Controls
- Blog posts: Only published (published_at NOT NULL)
- Claim cards: Only visible (visible_in_audits = TRUE)
- 404 responses if found but not published/visible (prevents leaking existence)

### Response Structure
- Blog posts: Lightweight response (no nested relationships)
- Claim cards: Full response with sources, category_tags, apologetics_tags
- All UUIDs serialized as strings for JSON compatibility
- All timestamps serialized as ISO 8601 strings

---

## Code Changes

**Modified Files:**
1. `src/backend/database/repositories.py`:
   - Enhanced ClaimCardRepository.get_all() with 3 new filter params
   - Added ClaimCardRepository.count() method
   - Added BlogPostRepository.count() method

2. `src/backend/main.py`:
   - Added GET /api/blog/posts
   - Added GET /api/blog/posts/{post_id}
   - Added GET /api/audits/cards
   - Added GET /api/audits/cards/{card_id}

**Total additions:** ~250 lines (4 endpoints + 2 repository methods)

---

## Testing Notes

### Manual Testing Checklist:

**Blog Endpoints:**
- [ ] GET /api/blog/posts returns empty list if no published posts
- [ ] GET /api/blog/posts returns only published posts (not drafts)
- [ ] GET /api/blog/posts pagination works correctly
- [ ] GET /api/blog/posts has_more flag is accurate
- [ ] GET /api/blog/posts/{id} returns 404 for unpublished post
- [ ] GET /api/blog/posts/{id} returns 404 for non-existent post

**Audits Endpoints:**
- [ ] GET /api/audits/cards returns only visible_in_audits=TRUE cards
- [ ] GET /api/audits/cards category filter works
- [ ] GET /api/audits/cards verdict filter works
- [ ] GET /api/audits/cards search filter (case-insensitive)
- [ ] GET /api/audits/cards pagination works correctly
- [ ] GET /api/audits/cards/{id} returns 404 for non-visible card
- [ ] GET /api/audits/cards/{id} returns full card with relationships

### Test Data Requirements:
- Need at least 1 published blog post
- Need at least 1 unpublished blog post (to test 404)
- Need claim cards with visible_in_audits=TRUE
- Need claim cards with visible_in_audits=FALSE (to test filtering)
- Need claim cards with different verdicts (for filter testing)

---

## Next Steps (Phase 3.6)

**Admin UI** (topic queue, review interface, settings):
- Topic queue management table
- Blog post review interface
- Approve/reject/revision controls
- Scheduler settings UI
- Auto-suggest settings UI

---

## Notes

- All endpoints are public (no authentication required)
- Consistent response structure across all list endpoints
- Error handling: 404 for not found, 422 for invalid filters
- No websocket events needed (public read-only endpoints)
- Backend implementation complete - ready for frontend integration

---

## Session Artifacts

**Files Modified:**
- `src/backend/database/repositories.py`
- `src/backend/main.py`

**New Endpoints:**
- GET /api/blog/posts
- GET /api/blog/posts/{id}
- GET /api/audits/cards
- GET /api/audits/cards/{id}

**Session Duration:** ~30 minutes
**Complexity:** Medium (repository enhancements + 4 endpoints)
