# Phase 3.1: Database & Topic Queue Backend

**Date:** 2026-01-16
**Type:** Implementation
**Phase:** 3.1 (Auto-Blog System)

---

## Context

Phase 2 (Conversational Chat) complete with intelligent routing. Starting Phase 3 (Auto-Blog System) per ADR 003.

**Goal:** Database schema + topic queue CRUD + admin API for blog post management.

---

## Scope

Implemented per ADR 003 lines 549-554 (Phase 3.1 breakdown):

1. ✓ Migration: Create `blog_posts` table
2. ✓ Migration: Add `visible_in_audits` to `claim_cards`
3. ✓ Migration: Add review workflow fields to `topic_queue`
4. ✓ Repository: `BlogPostRepository` with CRUD operations
5. ✓ API: Admin endpoints for topic queue management

---

## Database Changes

### Migration: `c29cd8c921ce_add_blog_posts_and_review_workflow.py`

**New table: blog_posts**
```sql
CREATE TABLE blog_posts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    topic_queue_id UUID REFERENCES topic_queue(id) ON DELETE SET NULL,
    title VARCHAR(500) NOT NULL,
    article_body TEXT NOT NULL,  -- Full synthesized prose article
    claim_card_ids UUID[] NOT NULL,
    published_at TIMESTAMP NULL,  -- NULL = not published, NOW() = published
    reviewed_by VARCHAR(200) NULL,
    review_notes TEXT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX ix_blog_posts_published_at ON blog_posts(published_at);
CREATE INDEX ix_blog_posts_topic_queue_id ON blog_posts(topic_queue_id);
```

**Modifications to claim_cards:**
```sql
ALTER TABLE claim_cards ADD COLUMN visible_in_audits BOOLEAN DEFAULT TRUE;
```

**Modifications to topic_queue:**
```sql
ALTER TABLE topic_queue ADD COLUMN review_status VARCHAR(50) DEFAULT 'pending_review';
ALTER TABLE topic_queue ADD COLUMN reviewed_at TIMESTAMP NULL;
ALTER TABLE topic_queue ADD COLUMN admin_feedback TEXT NULL;
ALTER TABLE topic_queue ADD COLUMN blog_post_id UUID REFERENCES blog_posts(id) ON DELETE SET NULL;

CREATE INDEX ix_topic_queue_review_status ON topic_queue(review_status);
```

---

## Models

### New: ReviewStatusEnum
```python
class ReviewStatusEnum(str, enum.Enum):
    PENDING_REVIEW = "pending_review"
    APPROVED = "approved"
    REJECTED = "rejected"
    NEEDS_REVISION = "needs_revision"
```

### New: BlogPost Model
- Located: `src/backend/database/models.py` lines 301-348
- Represents synthesized prose articles from decomposed topics
- Links to `topic_queue` and references `claim_card_ids` array
- `published_at` controls visibility in Read page (NULL = not published)

### Modified: ClaimCard Model
- Added `visible_in_audits` (Boolean, default=True)
- Allows admin to hide low-quality cards from Audits page while keeping them in chat

### Modified: TopicQueue Model
- Added `review_status`, `reviewed_at`, `admin_feedback`, `blog_post_id`
- Supports review workflow for blog post generation

---

## Repositories

### New: BlogPostRepository
Located: `src/backend/database/repositories.py` lines 483-609

**Methods:**
- `get_by_id(post_id)` - Fetch single blog post
- `get_all(skip, limit, published_only)` - List with pagination and publish filter
- `get_by_topic_queue_id(topic_queue_id)` - Find blog post for topic
- `create(blog_post)` - Insert new blog post
- `update(blog_post)` - Update existing blog post
- `delete(post_id)` - Remove blog post
- `publish(post_id, reviewed_by, review_notes)` - Set `published_at` timestamp
- `unpublish(post_id)` - Clear `published_at` timestamp

---

## API Endpoints

### Admin Topic Queue Management

**POST /api/admin/topics**
- Create new topic manually
- Body: `{ topic_text, priority?, source? }`
- Returns: Created topic with ID

**GET /api/admin/topics**
- List topics with filters
- Query params: `skip`, `limit`, `status`, `review_status`
- Returns: Paginated list of topics

**PUT /api/admin/topics/{topic_id}**
- Update topic fields
- Body: `{ topic_text?, priority?, status?, source? }`
- Returns: Updated topic

**DELETE /api/admin/topics/{topic_id}**
- Remove topic from queue
- Returns: Success confirmation

**Validation:**
- Empty `topic_text` rejected (400)
- Invalid status enum rejected (400)
- Missing topic returns 404

---

## File Changes

```
src/backend/database/
├── migrations/versions/
│   └── c29cd8c921ce_add_blog_posts_and_review_workflow.py  (NEW)
├── models.py                                               (MODIFIED)
│   ├── Added ReviewStatusEnum
│   ├── Added BlogPost model
│   ├── Modified ClaimCard (visible_in_audits)
│   └── Modified TopicQueue (review workflow fields)
└── repositories.py                                         (MODIFIED)
    └── Added BlogPostRepository

src/backend/main.py                                         (MODIFIED)
├── Added BlogPostRepository import
├── Added ReviewStatusEnum import
├── Added AdminTopicCreateRequest, AdminTopicUpdateRequest models
├── Added POST /api/admin/topics
├── Added GET /api/admin/topics
├── Added PUT /api/admin/topics/{topic_id}
└── Added DELETE /api/admin/topics/{topic_id}
```

---

## Testing Steps

1. **Apply migration:**
   ```bash
   cd src/backend
   source venv/bin/activate
   alembic upgrade head
   ```

2. **Verify schema:**
   ```sql
   -- Check blog_posts table exists
   \d blog_posts

   -- Check claim_cards.visible_in_audits column
   \d claim_cards

   -- Check topic_queue review fields
   \d topic_queue
   ```

3. **Test admin API:**
   ```bash
   # Create topic
   curl -X POST http://192.168.50.10:8008/api/admin/topics \
     -H "Content-Type: application/json" \
     -d '{"topic_text": "Test topic", "priority": 5}'

   # List topics
   curl http://192.168.50.10:8008/api/admin/topics

   # Update topic
   curl -X PUT http://192.168.50.10:8008/api/admin/topics/{id} \
     -H "Content-Type: application/json" \
     -d '{"priority": 10}'

   # Delete topic
   curl -X DELETE http://192.168.50.10:8008/api/admin/topics/{id}
   ```

---

## Next Steps

**Phase 3.2: Decomposer & Blog Composer**
- Decomposer agent (break topics into component claims)
- Blog Composer agent (generate article title + prose body)
- Agent prompts (seed database)
- Deduplication logic (semantic search for component claims)

**Phase 3.3: Scheduler & Auto-Suggest**
- APScheduler setup
- Full scheduler flow (decomposer → pipeline → composer)
- Auto-suggest service (LLM topic discovery)
- API endpoints for scheduler/autosuggest config

---

## Notes

- Migration creates circular FK between `blog_posts` and `topic_queue` (both use ON DELETE SET NULL)
- Admin endpoints have no authentication (add in production)
- Review workflow incomplete - full implementation in Phase 3.4
- Blog Composer agent not yet implemented - Phase 3.2

---

**Status:** Phase 3.1 complete. Database schema and admin API ready for Phase 3.2 (agents).
