# Session: Phase 1.2 - FastAPI Application Scaffold

**Date:** 2026-01-12
**Phase:** Foundation - FastAPI Scaffold
**Status:** Complete ✓

---

## Objectives

Build FastAPI application structure with database integration:
- Add category_tags table (dual categorization support)
- Create main FastAPI application with CORS
- Implement database session management
- Create repository pattern for data access
- Implement REST endpoints for all core entities
- Create seed scripts for agent prompts

---

## Completed Tasks

### 1. Category Tags Table (New Migration)

**Migration:** `d2c6d3c1f6dc_add_category_tags_table.py`

Added `CategoryTag` model to support dual categorization per ADR 001:
- **claim_type**: Technical, flexible categorization (e.g., "history", "science", "doctrine")
- **category_tags**: Broad UI navigation (Genesis, Canon, Doctrine, Ethics, Institutions)

**Schema:**
```python
category_tags:
  - id (UUID, PK)
  - claim_card_id (UUID, FK → claim_cards.id)
  - category_name (VARCHAR) - Flexible, not enum
  - description (TEXT, nullable)
  - created_at (TIMESTAMP)
  - Indexes: claim_card_id, category_name
```

**Relationships:**
- ClaimCard.category_tags → List[CategoryTag]
- CategoryTag.claim_card → ClaimCard
- Cascade delete when claim card deleted

**Migration Applied:** ✓
```bash
alembic upgrade head
# Running upgrade 597a35a22323 -> d2c6d3c1f6dc
```

### 2. Database Session Management

**File:** `src/backend/database/session.py`

Created async session management for FastAPI:

**Components:**
- Async engine with connection pooling (size=10, overflow=20)
- AsyncSessionFactory using async_sessionmaker
- `get_db()` dependency for FastAPI dependency injection

**Features:**
- Auto-commit on success
- Auto-rollback on exception
- Connection pre-ping for health checks
- Proper cleanup via context manager

**Usage:**
```python
@app.get("/items")
async def list_items(db: AsyncSession = Depends(get_db)):
    # Use db session
    ...
```

### 3. Repository Pattern

**File:** `src/backend/database/repositories.py`

Implemented 4 repository classes following clean architecture principles.

#### ClaimCardRepository
- `get_by_id(claim_id)` - With all relationships loaded
- `get_all(skip, limit, category)` - Pagination + optional category filter
- `create(claim_card)` - Create new claim card
- `update(claim_card)` - Update existing
- `delete(claim_id)` - Delete by ID

**Key Features:**
- Eager loading of sources, apologetics_tags, category_tags via selectinload
- Category filtering via JOIN on category_tags
- Ordered by created_at descending
- Returns unique results (handles eager loading duplicates)

#### AgentPromptRepository
- `get_by_agent_name(agent_name)` - Get config for specific agent
- `get_all()` - List all agent configurations
- `create(agent_prompt)` - Create new agent
- `update(agent_prompt)` - Update existing
- `delete(agent_name)` - Delete by name

#### TopicQueueRepository
- `get_by_id(topic_id)` - Get topic by ID
- `get_all(skip, limit, status)` - Pagination + optional status filter
- `get_next_queued()` - Get highest priority queued topic
- `create(topic)` - Create new topic
- `update(topic)` - Update existing
- `delete(topic_id)` - Delete by ID

**Key Features:**
- Ordered by priority (desc), then created_at (asc)
- Status filtering for admin views
- Helper method for scheduler to get next work item

#### CategoryTagRepository
- `get_by_claim_id(claim_id)` - Get all categories for a claim
- `get_unique_categories()` - List distinct category names
- `create(category_tag)` - Create new tag
- `delete(tag_id)` - Delete by ID

**Key Features:**
- Fast lookup of available categories for UI
- Support for multi-category claims

### 4. FastAPI Application

**File:** `src/backend/main.py`

Created main FastAPI application with CORS and REST endpoints.

**Configuration:**
- Title: "TheReceipts API"
- Version: 0.1.0
- CORS: Allow all origins (restrict in production)
- Binds to 0.0.0.0 for internal network access

#### Endpoints

**GET /health**
- Basic health check
- Returns service name and version
- No authentication required

**GET /api/claim-cards**
- List claim cards with pagination
- Query params: `skip`, `limit` (max 100), `category`
- Returns full claim cards with all relationships
- Ordered by created_at descending

**Response Format:**
```json
{
  "claim_cards": [
    {
      "id": "uuid",
      "claim_text": "...",
      "claimant": "...",
      "claim_type": "...",
      "verdict": "...",
      "short_answer": "...",
      "deep_answer": "...",
      "why_persists": [...],
      "confidence_level": "...",
      "confidence_explanation": "...",
      "agent_audit": {...},
      "created_at": "...",
      "updated_at": "...",
      "sources": [...],
      "apologetics_tags": [...],
      "category_tags": [...]
    }
  ],
  "pagination": {
    "skip": 0,
    "limit": 20,
    "count": 5
  }
}
```

**GET /api/agent-prompts**
- List all agent configurations
- No pagination (only 5 agents)
- Returns full prompt configs

**Response Format:**
```json
{
  "agent_prompts": [
    {
      "id": "uuid",
      "agent_name": "topic_finder",
      "llm_provider": "anthropic",
      "model_name": "claude-3-opus-20240229",
      "system_prompt": "...",
      "temperature": 0.7,
      "max_tokens": 2048,
      "created_at": "...",
      "updated_at": "..."
    }
  ]
}
```

**GET /api/topic-queue**
- List topics with pagination
- Query params: `skip`, `limit`, `status` (optional enum filter)
- Ordered by priority (descending)

**Response Format:**
```json
{
  "topics": [
    {
      "id": "uuid",
      "topic_text": "...",
      "priority": 100,
      "status": "queued",
      "source": "manual",
      "claim_card_ids": ["uuid1", "uuid2"],
      "scheduled_for": "2026-01-15T10:00:00",
      "error_message": null,
      "retry_count": 0,
      "created_at": "...",
      "updated_at": "..."
    }
  ],
  "pagination": {...}
}
```

**GET /api/categories**
- List unique category names
- Sorted alphabetically
- Used for UI navigation filters

**Response Format:**
```json
{
  "categories": ["Canon", "Doctrine", "Ethics", "Genesis", "Institutions"],
  "count": 5
}
```

### 5. Seed Scripts

**File:** `src/backend/database/seeds/seed_agent_prompts.py`

Seeds the 5 agent configurations required for the pipeline.

**Agents Seeded:**
1. **topic_finder** - Anthropic Claude 3 Opus
   - Identifies claim, claimant, why it matters
   - Temperature: 0.7

2. **source_checker** - Anthropic Claude 3 Opus
   - Collects primary historical + scholarly sources
   - Identifies scholarly consensus
   - Temperature: 0.3 (more deterministic)

3. **adversarial_checker** - OpenAI GPT-4 Turbo
   - Attempts to falsify the draft
   - Verifies quotes and sources
   - Identifies logical fallacies
   - Temperature: 0.5

4. **writing_agent** - Anthropic Claude 3 Opus
   - Produces final prose
   - Calm, direct, forensic tone
   - Creates short + deep answers
   - Temperature: 0.7

5. **publisher** - Anthropic Claude 3 Sonnet
   - Creates audit summary
   - States limitations
   - Identifies what would change verdict
   - Temperature: 0.3 (quality check)

**Usage:**
```bash
cd src/backend
source venv/bin/activate
python database/seeds/seed_agent_prompts.py
```

**File:** `src/backend/database/seeds/categories_reference.py`

Documents standard categories (Genesis, Canon, Doctrine, Ethics, Institutions).
Categories are assigned when claim cards are created, not seeded separately.

---

## Files Created

```
src/backend/
├── main.py                                       # FastAPI app (238 lines)
├── database/
│   ├── session.py                                # Session management (50 lines)
│   ├── repositories.py                           # 4 repositories (245 lines)
│   ├── models.py                                 # Updated with CategoryTag
│   ├── migrations/
│   │   └── versions/
│   │       └── d2c6d3c1f6dc_add_category_tags_table.py  # New migration
│   └── seeds/
│       ├── seed_agent_prompts.py                 # Agent config seeder
│       └── categories_reference.py               # Category documentation
```

---

## Database Schema Updates

**New Table:**
- `category_tags` - Broad UI navigation categories

**Updated Relationships:**
- ClaimCard now has `category_tags` relationship

**Current Tables (6 total):**
1. claim_cards
2. sources
3. apologetics_tags
4. category_tags (NEW)
5. agent_prompts
6. topic_queue

---

## Key Design Decisions

### 1. Repository Pattern
- Clean separation of data access logic
- Easier to test (can mock repositories)
- Consistent interface across all models
- All database queries go through repositories (not in routes)

### 2. Async Throughout
- AsyncSession for database operations
- All repository methods are async
- FastAPI endpoints use async/await
- Better performance for I/O-bound operations

### 3. Eager Loading
- ClaimCard queries use selectinload for relationships
- Prevents N+1 query problems
- Single query fetches all related data
- Returns complete objects ready for JSON serialization

### 4. Flexible Category Names
- category_name is VARCHAR, not ENUM
- Allows future expansion beyond initial 5 categories
- Standard categories documented but not enforced
- UI can dynamically show all categories via `/api/categories`

### 5. Pagination Limits
- Maximum 100 records per request
- Prevents memory issues with large result sets
- Client can paginate through full dataset
- Returns count for UI feedback

### 6. CORS Configuration
- Currently allows all origins (development)
- Should be restricted in production
- Allows credentials for future auth
- All methods and headers allowed for flexibility

---

## Testing

Manual verification of endpoints:
```bash
# Start server
cd src/backend
source venv/bin/activate
uvicorn main:app --host 0.0.0.0 --port 8000

# In another terminal:
# Health check
curl http://localhost:8000/health

# List claim cards (empty initially)
curl http://localhost:8000/api/claim-cards

# List agent prompts (after seeding)
curl http://localhost:8000/api/agent-prompts

# List topic queue (empty initially)
curl http://localhost:8000/api/topic-queue

# List categories (empty initially)
curl http://localhost:8000/api/categories
```

---

## Next Steps (Phase 1.3)

React frontend scaffold:
- Vite setup with React + TypeScript
- React Router for navigation
- Basic layout with header/nav
- API client for backend communication
- Initial pages (Ask, Read, Audits)

Future enhancements for Phase 1.2:
- Run agent_prompts seed script
- Add more endpoints (POST, PUT, DELETE) as needed
- Add API documentation (FastAPI auto-generates at /docs)
- Add request/response models using Pydantic
- Add error handling middleware
- Add logging

---

## Notes

- FastAPI binds to 0.0.0.0 (accessible on internal network per requirements)
- User manually starts services (Claude never auto-starts)
- Agent prompts are placeholder system prompts (will be refined iteratively)
- Repository pattern makes it easy to add caching or other cross-cutting concerns later
- All UUID IDs converted to strings in JSON responses (JSON doesn't support UUID type)
- Category filtering in claim cards uses JOIN (could be optimized with subquery if needed)

---

## ADR 001 Alignment

✓ FastAPI backend with async/await
✓ Database session management ready for LLM orchestration
✓ Repository pattern for clean data access
✓ Support for 5-agent pipeline (agent_prompts table + seed script)
✓ Dual categorization (claim_type + category_tags)
✓ Pagination for scalability
✓ REST endpoints for all core entities
✓ CORS configured for React frontend
✓ Service binds to 0.0.0.0 for internal network access

Session complete. FastAPI scaffold ready for Phase 1.3 (React frontend).
