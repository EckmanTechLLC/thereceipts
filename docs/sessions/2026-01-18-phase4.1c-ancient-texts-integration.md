# Phase 4.1c: Ancient Texts Integration (Tier 3)

**Date:** 2026-01-18
**Type:** Implementation
**Status:** Complete

---

## Context

Phase 4.1b complete (Adversarial Re-Verification).
Phase 4.1c adds Tier 3 (Ancient/Religious Texts) to the multi-tier source verification system.

**Problem Addressed:**
- Christianity-focused claims require access to ancient/religious texts
- Early church fathers, patristic writings, ancient Greek/Latin texts needed for verification
- No API integration for these specialized sources in Tiers 0-2, 4-5

**References:**
- ADR 004: Multi-Source Verification (Tier 3 specification)
- Phase 4.1a session notes (source verification core implementation)
- Phase 4.1b session notes (adversarial re-verification)

---

## Implementation Summary

### Modified File: `src/backend/services/source_verification.py`

**Changes:**

1. **Updated module docstring** (lines 1-11):
   - Changed from "5-tier" to "6-tier" system
   - Added Tier 3: Ancient Texts (Perseus CTS API, CCEL)

2. **Updated class docstring** (lines 57-67):
   - Added Tier 3 to verification sequence
   - Updated tier numbering (Tier 3 between Tier 2 and Tier 4)

3. **Updated `verify_source()` method** (lines 131-137):
   - Added Tier 3 check between Tier 2 (Semantic Scholar) and Tier 4 (Tavily)
   - Triggers for source_type containing: "ancient", "religious", "patristic"
   - Adds verified ancient texts to library for reuse

4. **Added `_check_ancient_texts()` method** (lines 407-431):
   - Main Tier 3 entry point
   - Tries Perseus Digital Library first (ancient Greek/Latin)
   - Falls back to CCEL (Christian classics)
   - Returns first successful match or None

5. **Added `_check_perseus()` method** (lines 433-494):
   - Perseus Digital Library integration
   - Uses Perseus Hopper search endpoint
   - Searches for ancient Greek/Latin texts
   - Returns verification result with Perseus URL
   - **Limitation:** HTML-based search (no clean JSON API)
   - **Note:** Full CTS URN support would require more sophisticated parsing

6. **Added `_check_ccel()` method** (lines 496-560):
   - CCEL (Christian Classics Ethereal Library) integration
   - Uses CCEL site search
   - Extracts first result link via regex
   - Verifies URL accessibility
   - Returns verification result with CCEL URL

7. **Updated `_add_to_library()` method** (lines 661-670):
   - Now accepts Tier 1-3 sources (was Tier 1-2)
   - Ancient texts can be added to verified source library
   - Enables reuse via Tier 0 semantic search

---

## API Research

### Perseus Digital Library

**Resources:**
- [Perseus CTS API Documentation](https://sites.tufts.edu/perseusupdates/beta-features/perseus-cts-api/)
- [rperseus R Package](https://docs.ropensci.org/rperseus/)

**Endpoints:**
- CTS API: `http://www.perseus.tufts.edu/hopper/CTS`
- Search: `http://www.perseus.tufts.edu/hopper/searchresults`

**Capabilities:**
- GetCapabilities, GetValidReff, GetPassage requests
- URN-based text retrieval (e.g., `urn:cts:greekLit:tlg0012.tlg001`)
- Ancient Greek, Latin, Hebrew texts
- Homer, Cicero, Boethius, etc.

**Limitations:**
- No clean JSON search API
- HTML-based search results require parsing
- CTS API requires known URN identifiers
- Basic implementation uses search endpoint with HTML response

**Implementation Choice:**
- Used Perseus Hopper search for initial integration
- Returns search results URL as working link
- Full CTS URN support deferred (would require work catalog and URN mapping)

### CCEL (Christian Classics Ethereal Library)

**Resources:**
- [CCEL Web Tools](https://www.ccel.org/webtools.html)
- [CCEL Home](https://ccel.org/)

**Endpoints:**
- Search: `https://www.ccel.org/search?qu=[query]`
- Scripture: `https://ccel.org/ajax/scripture` (for Bible passages)
- Work sections: `[work_url]?html=true` (for HTML content)

**Capabilities:**
- Early church fathers, theologians
- Christian classics and theological works
- Full-text HTML access
- Working URLs to source texts

**Limitations:**
- No formal REST API
- HTML search results (requires regex extraction)
- Limited metadata in search responses

**Implementation Choice:**
- Used site search with basic HTML parsing
- Extracts first result link via regex
- Verifies URL before returning result

### Early Church Texts

**Research Results:**
- [EarlyChurchTexts.com](https://earlychurchtexts.com/) - website only, no API
- [Patristic Text Archive](https://pta.bbaw.de/en/) - project timeline 2020-2026
- No documented programmatic API available

**Decision:**
- Not implemented as separate API integration
- CCEL covers most early church fathers and patristic writings
- Can fall back to Tier 4 (Tavily) for web search of Early Church Texts website

---

## Integration Flow

### Source Verification Sequence (Updated)

**Tier 0: Verified Source Library**
- Semantic search (0.85 similarity) + LLM relevance check
- Fast reuse of previously verified sources

**Tier 1: Google Books API**
- Modern academic books
- Triggered by source_type: "book", "historical"

**Tier 2: Semantic Scholar API**
- Academic papers
- Triggered by source_type: "scholarly", "peer-reviewed"

**Tier 3: Ancient Texts (NEW)**
- Perseus Digital Library → ancient Greek/Latin texts
- CCEL → Christian classics, church fathers
- Triggered by source_type: "ancient", "religious", "patristic"

**Tier 4: Tavily API**
- Web sources
- Fallback for any source type

**Tier 5: LLM Fallback**
- Unverified sources
- Transparent disclaimer

---

## Design Decisions

### 1. Multiple APIs in Single Tier

**Approach:** Try all Tier 3 APIs sequentially, return first success

**Rationale:**
- Perseus and CCEL have different text collections
- Perseus: Ancient Greek/Latin classics
- CCEL: Christian theological works
- Together they cover ancient texts needed for Christianity claims
- Sequential tries align with "fail soft" principle

**Alternative Considered:**
- Parallel API calls with asyncio.gather()
- Rejected: Sequential is simpler, still fast (~2-3s per API)

### 2. Basic HTML Parsing vs Full API Integration

**Approach:** Basic regex extraction from HTML search results

**Rationale:**
- Neither Perseus nor CCEL have clean JSON APIs for search
- Full HTML parsing would require BeautifulSoup/lxml (new dependencies)
- Basic regex sufficient for Phase 4.1c (extract first result link)
- Returns working URLs (primary goal met)

**Trade-off:**
- Less robust than full HTML parsing
- May miss results if HTML structure changes
- Good enough for initial integration

**Future Enhancement:**
- Proper HTML parsing with BeautifulSoup
- Perseus CTS URN catalog integration
- CCEL work ID mapping

### 3. Tier 3 Source Type Triggers

**Triggers:** "ancient", "religious", "patristic" in source_type

**Rationale:**
- Source Checker agent generates source_type based on claim
- These keywords indicate need for ancient/religious texts
- Aligns with Christianity focus of project
- Keeps Tier 1-2 for modern academic sources

**Coverage:**
- "ancient" → Perseus (Greek/Latin classics)
- "religious" or "patristic" → CCEL (Christian texts)
- If both fail → falls through to Tier 4 (Tavily)

### 4. Adding Tier 3 to Library

**Approach:** Ancient texts added to verified source library (same as Tier 1-2)

**Rationale:**
- Ancient texts are reusable across similar claims
- E.g., "Ignatius of Antioch" relevant to multiple early church claims
- Semantic search enables fast lookup (Tier 0)
- Reduces API calls over time

**Library Storage:**
- source_type: "ancient_text"
- verification_method: "perseus_digital_library" or "ccel"
- URL verified and stored for reuse
- Embeddings enable semantic matching

---

## Verification Metadata

**Tier 3 Results Include:**

```python
SourceVerificationResult(
    success=True,
    tier=3,
    verification_method="perseus_digital_library" | "ccel",
    verification_status="verified" | "partially_verified",
    citation="CCEL: Augustine Confessions" | "Perseus Digital Library: Homer Iliad",
    url="https://www.ccel.org/ccel/augustine/confessions" | "http://perseus.tufts.edu/...",
    quote_text=None,  # Source Checker extracts actual quote
    content_type="exact_quote" | "verified_paraphrase",
    url_verified=True,
    metadata={
        "title": "[work title]",
        "source_type": "ancient_text",
        "note": "Christian Classics Ethereal Library" | "Perseus Digital Library search result"
    }
)
```

**Verification Status:**
- CCEL: `verified` (direct link to work)
- Perseus: `partially_verified` (search result, not direct passage)

---

## Testing Notes

### Prerequisites

1. No new API keys required:
   - Perseus: Public access (no key)
   - CCEL: Public access (no key)
   - Uses existing OpenAI, Google Books, Tavily keys from Phase 4.1a

2. Phase 4.1a/4.1b migrations applied:
   ```bash
   cd src/backend
   alembic current  # Should show: d6638e843688
   ```

3. Backend dependencies already installed (httpx for HTTP requests)

### Manual Testing

**Test 1: Ancient Greek/Latin Text (Perseus)**
1. Ask question requiring ancient Greek/Latin source
   - Example: "What did Homer say about the Trojan War?"
2. Source Checker should attempt Tier 3 (Perseus)
3. Check agent_audit:
   - verification_method: "perseus_digital_library"
   - tier: 3
   - URL should be Perseus search results link

**Test 2: Christian Classic (CCEL)**
1. Ask question requiring early church father or theological work
   - Example: "What did Augustine say about original sin?"
2. Source Checker should attempt Tier 3 (CCEL)
3. Check agent_audit:
   - verification_method: "ccel"
   - tier: 3
   - URL should be direct CCEL work link

**Test 3: Library Reuse (Tier 0 Hit)**
1. Run pipeline for similar claims requiring same ancient text
   - First run: Tier 3 (CCEL/Perseus) → adds to library
   - Second run: Tier 0 (library reuse) → faster
2. Check verification_method:
   - Second run should show: "library_reuse_ccel" or "library_reuse_perseus_digital_library"

**Test 4: Adversarial Re-Verification**
1. Adversarial Checker should re-verify Tier 3 sources
2. Check reverification_notes in agent_audit:
   - Should show Tier 3 verification results
   - May flag: "Quote may not match source content" (API limitations)

**Edge Cases:**
- Source query returns no results (both Perseus and CCEL fail)
  - Should fall through to Tier 4 (Tavily)
- API timeout or error
  - Should catch exception, return None, fall through
- URL verification fails (broken link)
  - Should flag url_verified=False but still return result

---

## Performance Impact

**Current Pipeline (Phase 4.1b):** ~60-80s per claim card

**With Phase 4.1c (Tier 3 Integration):**
- Tier 3 adds: +2-5s per ancient text source
- Most claims have 0-2 ancient text sources
- Average impact: +0-10s per claim card

**Estimated Total:** ~60-90s per claim card

**Mitigation:**
- Tier 0 (library hits) reduce time over multiple runs
- Tier 3 only triggers for "ancient", "religious", "patristic" source types
- Not all claims need ancient texts

---

## Files Modified

**Modified:**
- `src/backend/services/source_verification.py`:
  - Updated module docstring (6-tier system)
  - Updated class docstring (added Tier 3)
  - Modified verify_source() method (+7 lines: Tier 3 integration)
  - Added _check_ancient_texts() method (+25 lines)
  - Added _check_perseus() method (+62 lines)
  - Added _check_ccel() method (+65 lines)
  - Updated _add_to_library() docstring and comment

**Total:** ~165 lines of implementation

---

## Success Criteria

Phase 4.1c complete when:
- [x] Perseus Digital Library API integration (_check_perseus)
- [x] CCEL API integration (_check_ccel)
- [x] _check_ancient_texts() method tries both APIs
- [x] verify_source() calls Tier 3 between Tier 2 and Tier 4
- [x] Tier 3 triggered by "ancient", "religious", "patristic" source types
- [x] Tier 3 sources added to library for reuse
- [x] Module/class docstrings updated (6-tier system)

**Testing:** User will run services and test with Christianity-focused claims requiring ancient texts.

---

## Known Limitations

### Perseus Digital Library
- No clean JSON API for search
- Basic implementation uses HTML search endpoint
- Full CTS URN support requires work catalog mapping
- Returns search results page (not direct passage link)
- URL points to search results, not specific text passage

**Future Enhancement:**
- Parse HTML search results for first work link
- Implement CTS GetPassage for direct text retrieval
- Build Perseus work catalog with URN mappings
- Extract actual text passages instead of search results

### CCEL
- No formal REST API
- HTML search results require regex extraction
- Limited metadata in responses (no author, date, etc.)
- Basic regex may fail if HTML structure changes

**Future Enhancement:**
- BeautifulSoup/lxml for robust HTML parsing
- CCEL work ID catalog for direct work access
- Extract structured metadata (author, date, work type)
- Use CCEL's fragment API for specific passages

### Quote Verification
- APIs provide limited content (search results, not full text)
- Cannot extract exact quotes from Perseus/CCEL via API
- Source Checker must generate quotes (not extract from API)
- Adversarial Checker re-verification limited by API content availability

**Acceptable for Phase 4.1c:**
- Working URLs provided (primary goal met)
- Users can click through to read sources
- Better than LLM hallucinated sources (no links)
- Transparent about limitations

---

## Next Steps (Phase 4.1d)

**UI Transparency:**

Display verification status in ClaimCard component:
- Add icons/badges for verification confidence
- Show verification_method for each source
- Indicate Tier 3 sources (ancient texts) distinctly
- Test with verified vs unverified vs ancient text sources

**Files to modify:**
- `src/frontend/src/components/ClaimCard.tsx` (add verification status display)
- `src/frontend/src/types/claim.ts` (update ClaimSource type)

**Implementation:**
- Read source verification metadata from API
- Map verification_method to display labels
- Add confidence indicators (✓, ⓘ, ⚠)
- Keep display subtle (not alarmist)

---

## Notes

**Design Principles Maintained:**
- Fail soft (API failures fall through to next tier)
- Full transparency (verification method stored and visible)
- Database-stored prompts (LLM calls use agent prompts from DB)
- Incremental implementation (Tier 3 only, no other changes)

**User Preferences Honored:**
- Concise implementation (~165 lines, single file)
- Small incremental change (Phase 4.1c scope only)
- Stayed within defined task
- Documented as we went (~250 lines session notes)

**API Integration Approach:**
- Pragmatic over perfect (basic HTML parsing vs full API integration)
- Working URLs prioritized (primary goal met)
- Future enhancements noted (not implemented prematurely)
- Good enough for Phase 4.1c (can improve later)

**Alignment with ADR 004:**
- Tier 3 specification implemented as designed
- Multiple APIs in single tier (Perseus, CCEL)
- Sequential tries with first success return
- Ancient texts added to verified source library
- Verification metadata stored for transparency

---

**Status:** Implementation complete, ready for testing and Phase 4.1d (UI Transparency).

## Sources

Research sources consulted during implementation:

### CCEL
- [API - Christian Classics Ethereal Library](https://www.ccel.org/webtools.html)
- [Christian Classics Ethereal Library (CCEL) – Medieval Digital Resources](https://mdr-maa.org/resource/christian-classics-ethereal-library-ccel/)

### Perseus Digital Library
- [Perseus CTS API » Perseus Digital Library Updates](https://sites.tufts.edu/perseusupdates/beta-features/perseus-cts-api/)
- [Get Texts from the Perseus Digital Library • rperseus](https://docs.ropensci.org/rperseus/)
- [GitHub - ropensci/rperseus](https://github.com/ropensci/rperseus)

### Early Church Texts
- [Early Church Texts - entry page](https://earlychurchtexts.com/)
- [Patristic Text Archive | PTA](https://pta.bbaw.de/en/)
- [Early Church Fathers - Christian Classics Ethereal Library](https://www.ccel.org/fathers)
