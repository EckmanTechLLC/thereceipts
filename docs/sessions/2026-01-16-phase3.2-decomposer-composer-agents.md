# Phase 3.2: Decomposer & Blog Composer Agents

**Date:** 2026-01-16
**Type:** Implementation
**Status:** Complete

---

## Context

Phase 3.1 complete (database schema, blog_posts table, admin API).
This session implements two new agents for auto-blog article generation workflow.

**References:**
- ADR 003 lines 207-230 (Decomposer), 293-336 (Blog Composer)
- Phase 3 planning session lines 167-171

---

## Implementation Summary

### 1. DecomposerAgent

**File:** `src/backend/agents/decomposer.py`

**Purpose:** Breaks broad topics into component factual claims for comprehensive analysis.

**Key Features:**
- Variable claim count (3-12 based on topic complexity)
- Inherits from BaseAgent
- JSON output with component_claims array
- Validation: 3-12 claims required

**Input:**
```python
{
    "topic": "Noah's Flood",
    "context": "Optional context from topic queue"
}
```

**Output:**
```python
{
    "topic": "Noah's Flood",
    "component_claims": [
        "A global flood covered the entire Earth ~4,000 years ago",
        "Noah's Ark could fit all animal species",
        "Geological evidence supports a worldwide flood",
        ...
    ],
    "claim_count": 5,
    "reasoning": "LLM explanation",
    "usage": {...}
}
```

**Error Handling:**
- Raises AgentExecutionError if topic missing
- Validates claim count (3-12 range)
- Validates component_claims is list
- JSON parsing with extract_json_from_response()

---

### 2. BlogComposerAgent

**File:** `src/backend/agents/blog_composer.py`

**Purpose:** Generates full synthesized prose articles from claim cards.

**Key Features:**
- Synthesizes 500-1500 word articles
- Narrative prose (not list of claims)
- Contextual references to claim cards
- Inherits from BaseAgent

**Input:**
```python
{
    "topic": "Noah's Flood",
    "claim_cards": [
        {
            "claim_text": "...",
            "verdict": "False",
            "short_answer": "...",
            "deep_answer": "...",
            "sources": [...],
            ...
        },
        ...
    ]
}
```

**Output:**
```python
{
    "topic": "Noah's Flood",
    "title": "Noah's Flood: Examining the Claims...",
    "article_body": "The Genesis flood account makes...",
    "word_count": 987,
    "references": [
        {"number": 1, "claim_card_index": 0, "description": "..."},
        ...
    ],
    "usage": {...}
}
```

**Validation:**
- Word count: 400-1600 (allows slight flexibility)
- Required fields: title, article_body
- At least one claim card required

**Helper Method:**
- `_format_claim_cards()`: Formats claim cards for LLM consumption

---

### 3. System Prompts

**File:** `src/backend/database/seeds/seed_agent_prompts.py`

Added two entries to AGENT_PROMPTS list:

#### Decomposer System Prompt
- Model: claude-sonnet-4-5-20250929
- Temperature: 0.7
- Max tokens: 4096
- Guidelines: 3-5 claims (simple), 5-8 (medium), 8-12 (complex)
- Examples: Noah's Flood (5 claims), Gospel Reliability (7 claims)
- Output: JSON with component_claims array

#### Blog Composer System Prompt
- Model: claude-sonnet-4-5-20250929
- Temperature: 0.7
- Max tokens: 8192
- Tone: Calm, direct, forensic (matches claim card tone)
- Structure: Opening → Main body → Conclusion
- References: Numbered footnotes + descriptive links
- Length: 500-1500 words (target 800-1000)
- Output: JSON with title, article_body, references

---

### 4. Exports

**File:** `src/backend/agents/__init__.py`

Added imports and exports:
```python
from agents.decomposer import DecomposerAgent
from agents.blog_composer import BlogComposerAgent

__all__ = [
    ...,
    "DecomposerAgent",
    "BlogComposerAgent",
]
```

---

## Design Decisions

### 1. Inheritance Pattern
Both agents follow existing BaseAgent pattern:
- load_config() from database
- call_llm() for LLM interaction
- execute() for agent-specific logic
- JSON output with extract_json_from_response()

### 2. Error Handling
Fail-fast approach (consistent with ADR 001):
- AgentExecutionError for failures
- Validation at multiple levels (fields, ranges, types)
- No automatic retries

### 3. Flexibility vs Validation
Decomposer claim count:
- Flexible range (3-12) for topic complexity
- Validates range but doesn't enforce specific counts
- LLM decides based on topic

Blog Composer word count:
- Target: 800-1000 words
- Validation: 400-1600 (slight flexibility)
- Prevents too-short or too-long articles

### 4. Prompt Engineering
Decomposer:
- Examples for 3 complexity levels (simple, medium, complex)
- Specific guidance on claim types
- Focus on testable factual claims

Blog Composer:
- Example article excerpt
- Clear tone requirements
- Reference formatting guidance
- Structure requirements

---

## Integration Points (Not Implemented Yet)

These agents integrate with scheduler flow (Phase 3.3):

**Scheduled Generation Flow:**
1. Pick topic from queue
2. **→ DecomposerAgent** (breaks into component claims)
3. For each component claim:
   - Semantic search (>0.92 similarity)
   - If existing: reuse claim_card_id
   - If novel: run 5-agent pipeline → new claim card
4. **→ BlogComposerAgent** (synthesizes article from claim cards)
5. Create blog_posts row
6. Queue for admin review

**Deduplication Logic:**
Not implemented in this session. Will be in Phase 3.3 (scheduler service).
Uses semantic search (>0.92 similarity threshold) before running pipeline.

---

## Testing Notes

### Manual Testing (When Scheduler Implemented)
1. Test DecomposerAgent:
   - Simple topic (expect 3-5 claims)
   - Medium topic (expect 5-8 claims)
   - Complex topic (expect 8-12 claims)
   - Edge cases: Very simple/complex topics

2. Test BlogComposerAgent:
   - 3 claim cards (expect ~600 words)
   - 8 claim cards (expect ~1200 words)
   - Verify references formatted correctly
   - Verify tone matches claim cards

### Database Seeding
Run seed script to add new agent prompts:
```bash
cd src/backend
source venv/bin/activate
python database/seeds/seed_agent_prompts.py
```

---

## Files Modified/Created

**Created:**
- `src/backend/agents/decomposer.py` (112 lines)
- `src/backend/agents/blog_composer.py` (165 lines)
- `docs/sessions/2026-01-16-phase3.2-decomposer-composer-agents.md` (this file)

**Modified:**
- `src/backend/database/seeds/seed_agent_prompts.py` (+130 lines: 2 new agent entries)
- `src/backend/agents/__init__.py` (+18 lines: imports + exports)

**Total:** ~430 lines of implementation

---

## Success Criteria

Phase 3.2 complete when:
- [x] DecomposerAgent class implemented (breaks topics into 3-12 claims)
- [x] BlogComposerAgent class implemented (generates 500-1500 word articles)
- [x] System prompts added to seed_agent_prompts.py
- [x] Agents exported from agents/__init__.py
- [x] Session notes documented

---

## Next Steps (Phase 3.3)

**Scheduler & Auto-Suggest:**
1. Install APScheduler
2. Implement scheduler service:
   - Decomposer → semantic search → 5-agent pipeline → Blog Composer flow
   - Deduplication logic (semantic search >0.92)
   - Fail-fast error handling
3. Implement auto-suggest service:
   - LLM-based topic discovery
   - Web crawling configured sources
   - Priority scoring
4. API endpoints:
   - POST /api/admin/scheduler/run-now (manual trigger)
   - GET/PUT /api/admin/scheduler/settings
   - POST /api/admin/autosuggest/trigger
   - GET/PUT /api/admin/autosuggest/settings

---

## Notes

**Design Principles Maintained:**
- Fail fast (no retries)
- Database-stored prompts
- Consistent BaseAgent pattern
- JSON-structured output
- Clear error messages

**User Preferences Honored:**
- Concise session notes (~270 lines)
- Small incremental changes (2 agents only)
- Stayed within defined scope
- Documented as we went

---

**Status:** Implementation complete, ready for Phase 3.3 (Scheduler & Auto-Suggest).
